<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDR Calculator</title>

  <style>
    :root {
      --bg:#f3f4f6;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --accent:#2563eb;
      --result:#111827;
    }

    body.dark {
      --bg:#0f172a;
      --card:#111827;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --accent:#3b82f6;
      --result:#020617;
    }

    body {
      font-family: Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      margin:0;
      padding:12px;
      display:flex;
      justify-content:center;
      transition:0.2s;
    }

    .app {
      background:var(--card);
      max-width:800px;
      width:100%;
      border-radius:14px;
      padding:16px;
      box-shadow:0 10px 25px rgba(0,0,0,0.15);
    }

    .header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
    }

    .logo {
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:bold;
      font-size:18px;
    }

    .logoMark {
      width:36px;
      height:36px;
      border-radius:8px;
      background:linear-gradient(135deg,#2563eb,#22c55e);
      display:flex;
      align-items:center;
      justify-content:center;
      color:white;
      font-weight:bold;
    }

    .themeBtn {
      background:var(--accent);
      color:white;
      border:none;
      padding:8px 12px;
      border-radius:8px;
      cursor:pointer;
    }

    h3 { margin-bottom:6px; }

    .grid {
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }

    label {
      font-size:13px;
      color:var(--muted);
    }

    table {
      width:100%;
      border-collapse:collapse;
      margin:10px 0;
    }

    th, td {
      border-bottom:1px solid rgba(0,0,0,0.08);
      padding:6px;
      text-align:center;
      font-size:14px;
    }

    input, select {
      width:100%;
      padding:10px;
      border-radius:8px;
      border:1px solid #ccc;
      font-size:16px;
      box-sizing:border-box;
      background:var(--card);
      color:var(--text);
    }

    button {
      padding:12px;
      border:none;
      border-radius:10px;
      cursor:pointer;
      margin-top:8px;
      font-size:15px;
    }

    .primary { background:var(--accent); color:white; }
    .danger { background:#dc2626; color:white; }
    .success { background:#16a34a; color:white; }
    .warn { background:#f59e0b; color:white; }

    .result {
      margin-top:12px;
      background:var(--result);
      color:white;
      padding:16px;
      border-radius:12px;
      font-size:20px;
      text-align:center;
    }

    @media (max-width:640px) {
      .grid { grid-template-columns:1fr; }
      table thead { display:none; }
      table, tbody, tr, td { display:block; width:100%; }
      tr { background:rgba(0,0,0,0.05); border-radius:10px; margin-bottom:10px; padding:8px; }
      td { text-align:left; border:none; padding:4px 0; }
      td::before { font-weight:bold; display:block; font-size:12px; color:var(--muted); }
      td:nth-child(1)::before { content:"Размер"; }
      td:nth-child(2)::before { content:"Зона"; }
      td:nth-child(3)::before { content:"Сложность"; }
      td:nth-child(4)::before { content:"Цена"; }
      button { width:100%; }
    }

    @media print {
      button { display:none; }
      body { background:white; }
      .app { box-shadow:none; }
    }
  </style>
</head>
<body>

<div class="app" id="invoice">

  <div class="header">
    <div class="logo">
      <div class="logoMark">P</div>
      PDR PRO
    </div>
    <button class="themeBtn" onclick="toggleTheme()">Тема</button>
  </div>

  <h3>Смета на удаление вмятин без покраски</h3>

  <div class="grid">
    <div>
      <label>Номер заказа</label>
      <input id="orderNumber" value="001">
    </div>

    <div>
      <label>Дата</label>
      <input id="date" type="date">
    </div>

    <div>
      <label>Клиент</label>
      <input id="client" placeholder="Имя клиента">
    </div>

    <div>
      <label>Автомобиль</label>
      <input id="car" placeholder="Марка и модель">
    </div>
  </div>

  <table id="dentTable">
    <thead>
      <tr>
        <th>Размер</th>
        <th>Зона</th>
        <th>Сложность</th>
        <th>Цена</th>
        <th></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button class="primary" onclick="addDent()">Добавить вмятину</button>

  <h3>Дополнительно</h3>

  <label>Минимальная цена</label>
  <input id="minPrice" type="number" value="5000">

  <label>Скидка (%)</label>
  <input id="discount" type="number" value="0">

  <label>Часы</label>
  <input id="hours" type="number" value="1">

  <label>Ставка</label>
  <input id="rate" type="number" value="10000">

  <label>Материалы</label>
  <input id="materials" type="number" value="2000">

  <div style="margin-top:12px;border:1px solid rgba(0,0,0,0.1);border-radius:10px;padding:12px;">
  <div>Работы: <b id="laborSum">0 ₸</b></div>
  <div>Материалы: <b id="materialsSum">0 ₸</b></div>
  <div>Вмятины: <b id="dentsSum">0 ₸</b></div>
  <hr>
  <div class="result" id="total">Итого: 0 ₸</div>
</div>

  <button class="warn" onclick="exportPDF()">Экспорт PDF</button>
  <button class="success" onclick="saveData()">Сохранить</button>
</div>

<script>
const zoneK = { "дверь":1, "крыло":1.2, "капот":1.3, "крыша":1.5 };
const diffK = { "легкая":1, "средняя":1.5, "сложная":2 };

function toggleTheme(){
  document.body.classList.toggle("dark");
  localStorage.setItem("theme", document.body.classList.contains("dark") ? "dark" : "light");
}

(function(){
  if(localStorage.getItem("theme")==="dark"){
    document.body.classList.add("dark");
  }
})();

function addDent(size=5){
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td><input class="size" type="number" value="${size}"></td>
    <td>
      <select class="zone">
        <option>дверь</option>
        <option>крыло</option>
        <option>капот</option>
        <option>крыша</option>
      </select>
    </td>
    <td>
      <select class="diff">
        <option>легкая</option>
        <option>средняя</option>
        <option>сложная</option>
      </select>
    </td>
    <td class="price">0</td>
    <td><button class="danger" onclick="removeDent(this)">Удалить</button></td>`;

  document.querySelector("#dentTable tbody").appendChild(tr);

  tr.querySelectorAll("input,select").forEach(el =>
    el.addEventListener("input", calc)
  );

  calc();
}

function removeDent(btn){
  btn.closest("tr").remove();
  calc();
}

function calc(){
  let dentsTotal = 0;
  const minPrice = +minPriceInput.value;

  document.querySelectorAll("#dentTable tbody tr").forEach(row=>{
    const size = +row.querySelector(".size").value;
    const zone = row.querySelector(".zone").value;
    const diff = row.querySelector(".diff").value;

    let p = size * 500 * zoneK[zone] * diffK[diff];
    p = Math.max(p, minPrice);

    row.querySelector(".price").innerText = Math.round(p);
    dentsTotal += p;
  });

  if(document.querySelectorAll("#dentTable tbody tr").length > 1){
    dentsTotal *= (1 - (+discountInput.value/100));
  }

  const labor = +hoursInput.value * +rateInput.value;
  const materialsCost = +materialsInput.value;
  const total = dentsTotal + labor + materialsCost;

  document.getElementById("laborSum").innerText = Math.round(labor) + " ₸";
  document.getElementById("materialsSum").innerText = Math.round(materialsCost) + " ₸";
  document.getElementById("dentsSum").innerText = Math.round(dentsTotal) + " ₸";

  totalDiv.innerText = "Итого: " + Math.round(total) + " ₸";
}

function saveData(){
  localStorage.setItem("pdr_invoice_html", document.getElementById("invoice").innerHTML);
  alert("Сохранено");
}

function exportPDF(){
  window.print();
}

const minPriceInput = document.getElementById("minPrice");
const discountInput = document.getElementById("discount");
const hoursInput = document.getElementById("hours");
const rateInput = document.getElementById("rate");
const materialsInput = document.getElementById("materials");
const totalDiv = document.getElementById("total");

[minPriceInput,discountInput,hoursInput,rateInput,materialsInput]
  .forEach(el=>el.addEventListener("input",calc));

addDent();
</script>

</body>
</html>
