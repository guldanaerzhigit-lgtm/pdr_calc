<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDR Calculator</title>

  <!-- QR library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; background:#f3f4f6; margin:0; padding:12px; display:flex; justify-content:center; }

    .app { background:white; max-width:800px; width:100%; border-radius:14px; padding:16px; box-shadow:0 10px 25px rgba(0,0,0,0.08); }

    h1 { font-size:22px; }
    h3 { margin-bottom:6px; }

    .grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; }

    label { font-size:13px; color:#555; }

    table { width:100%; border-collapse:collapse; margin:10px 0; }

    th, td { border-bottom:1px solid #eee; padding:6px; text-align:center; font-size:14px; }

    input, select {
      width:100%;
      padding:10px;
      border-radius:8px;
      border:1px solid #ccc;
      font-size:16px;
      box-sizing:border-box;
    }

    button { padding:12px; border:none; border-radius:10px; cursor:pointer; margin-top:8px; font-size:15px; }

    .primary { background:#2563eb; color:white; }
    .danger { background:#dc2626; color:white; }
    .success { background:#16a34a; color:white; }
    .warn { background:#f59e0b; color:white; }

    .result { margin-top:12px; background:#111827; color:white; padding:16px; border-radius:12px; font-size:20px; text-align:center; }

    .qrBox { text-align:center; margin-top:12px; }

    .readonly input,
    .readonly select,
    .readonly button.primary,
    .readonly button.success {
      pointer-events:none;
      opacity:0.6;
    }

    @media (max-width:640px) {
      .grid { grid-template-columns:1fr; }
      table thead { display:none; }
      table, tbody, tr, td { display:block; width:100%; }
      tr { background:#fafafa; border-radius:10px; margin-bottom:10px; padding:8px; }
      td { text-align:left; border:none; padding:4px 0; }
      td::before { font-weight:bold; display:block; font-size:12px; color:#666; }
      td:nth-child(1)::before { content:"Размер"; }
      td:nth-child(2)::before { content:"Зона"; }
      td:nth-child(3)::before { content:"Сложность"; }
      td:nth-child(4)::before { content:"Цена"; }
      button { width:100%; }
    }
  </style>
</head>
<body>

<div class="app" id="invoice">

  <h1>PDR SERVICE</h1>
  <h3>Смета на удаление вмятин без покраски</h3>

  <div class="grid">
    <div>
      <label>Номер заказа</label>
      <input id="orderNumber" value="001">
    </div>

    <div>
      <label>Клиент</label>
      <input id="client" placeholder="Имя клиента">
    </div>
  </div>

  <table id="dentTable">
    <thead>
      <tr>
        <th>Размер</th>
        <th>Зона</th>
        <th>Сложность</th>
        <th>Цена</th>
        <th></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button class="primary" onclick="addDent()">Добавить вмятину</button>

  <div class="result" id="total">Итого: 0 ₸</div>

  <button class="warn" onclick="generateQR()">QR для клиента</button>

  <div class="qrBox">
    <div id="qrcode"></div>
  </div>
</div>

<script>
const zoneK = { "дверь":1, "крыло":1.2, "капот":1.3, "крыша":1.5 };
const diffK = { "легкая":1, "средняя":1.5, "сложная":2 };

function addDent(size=5){
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td><input class="size" type="number" value="${size}"></td>
    <td>
      <select class="zone">
        <option>дверь</option>
        <option>крыло</option>
        <option>капот</option>
        <option>крыша</option>
      </select>
    </td>
    <td>
      <select class="diff">
        <option>легкая</option>
        <option>средняя</option>
        <option>сложная</option>
      </select>
    </td>
    <td class="price">0</td>
    <td><button class="danger" onclick="removeDent(this)">Удалить</button></td>`;

  document.querySelector("#dentTable tbody").appendChild(tr);
  tr.querySelectorAll("input,select").forEach(el => el.addEventListener("input", calc));
  calc();
}

function removeDent(btn){ btn.closest("tr").remove(); calc(); }

function calc(){
  let total=0;
  document.querySelectorAll("#dentTable tbody tr").forEach(row=>{
    let p=+row.querySelector(".size").value*500;
    p*=zoneK[row.querySelector(".zone").value];
    p*=diffK[row.querySelector(".diff").value];
    row.querySelector(".price").innerText=Math.round(p);
    total+=p;
  });
  totalDiv.innerText="Итого: "+Math.round(total)+" ₸";
}

function collectData(){
  const dents=[];
  document.querySelectorAll("#dentTable tbody tr").forEach(row=>{
    dents.push({
      size:row.querySelector(".size").value,
      zone:row.querySelector(".zone").value,
      diff:row.querySelector(".diff").value,
      price:row.querySelector(".price").innerText
    });
  });

  return {
    order:orderNumber.value,
    client:client.value,
    dents,
    total:totalDiv.innerText
  };
}

function generateQR(){
  const data=encodeURIComponent(JSON.stringify(collectData()));
  const url=location.origin+location.pathname+"?view=1&data="+data;

  document.getElementById("qrcode").innerHTML="";
  new QRCode(document.getElementById("qrcode"),{
    text:url,
    width:180,
    height:180
  });
}

function loadViewMode(){
  const params=new URLSearchParams(location.search);
  if(!params.get("view")) return;

  document.body.classList.add("readonly");

  const data=JSON.parse(decodeURIComponent(params.get("data")));

  orderNumber.value=data.order;
  client.value=data.client;

  document.querySelector("#dentTable tbody").innerHTML="";

  data.dents.forEach(d=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${d.size}</td><td>${d.zone}</td><td>${d.diff}</td><td>${d.price}</td><td></td>`;
    document.querySelector("#dentTable tbody").appendChild(tr);
  });

  totalDiv.innerText=data.total;
}

const totalDiv=document.getElementById("total");
const orderNumber=document.getElementById("orderNumber");
const client=document.getElementById("client");

addDent();
loadViewMode();
</script>

</body>
</html>
